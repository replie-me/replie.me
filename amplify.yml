version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # Set Node.js version explicitly with LTS version
            - nvm install 18.19.1
            - nvm use 18.19.1
            - nvm alias default 18.19.1
            # Install dependencies with frozen lockfile and no audit
            - npm install -g pnpm --no-audit
            - pnpm config set strict-peer-dependencies false
            - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 pnpm install --frozen-lockfile --no-optional
        build:
          commands:
            # Create env file with explicit environment variables
            - |
              cat << EOF > .env.production
              ADMIN_NAME=${ADMIN_NAME}
              ADMIN_EMAIL=${ADMIN_EMAIL}
              AUTH_SECRET=${AUTH_SECRET}
              AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
              AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
              STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
              BASE_URL=https://www.replie.me
              OPENAI_API_KEY=${OPENAI_API_KEY}
              RESEND_API_KEY=${RESEND_API_KEY}
              RESEND_FROM_NAME=${RESEND_FROM_NAME}
              RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}
              RESEND_TO_NAME=${RESEND_TO_NAME}
              RESEND_TO_EMAIL=${RESEND_TO_EMAIL}
              NEXTAUTH_URL=https://www.replie.me
              NEXTAUTH_SECRET=${AUTH_SECRET}
              NODE_ENV=production
              EOF
            # Verify environment file exists
            - test -f .env.production || (echo "Environment file not created" && exit 1)
            # Build with production flag and no source maps
            - NEXT_TELEMETRY_DISABLED=1 NODE_ENV=production pnpm run build
            # Copy files needed for SSR
            - cp -r .next/standalone/* .
            - cp -r .next/static .next/standalone/.next/static
            - cp next.config.ts .next/standalone/
            - cp package.json .next/standalone/
      artifacts:
        baseDirectory: .next/standalone
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
          - .pnpm-store/**/*
    appRoot: .