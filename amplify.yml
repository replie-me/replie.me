version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # Set Node.js version
            - nvm use 18
            # Install dependencies
            - npm install -g pnpm
            - pnpm install
        build:
          commands:
            # Create env file from Amplify environment variables
            - |
              cat << EOF > .env.production
              ADMIN_NAME=${ADMIN_NAME}
              ADMIN_EMAIL=${ADMIN_EMAIL}
              AUTH_SECRET=${AUTH_SECRET}
              AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
              AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
              STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
              BASE_URL=https://www.replie.me
              OPENAI_API_KEY=${OPENAI_API_KEY}
              RESEND_API_KEY=${RESEND_API_KEY}
              RESEND_FROM_NAME=${RESEND_FROM_NAME}
              RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}
              RESEND_TO_NAME=${RESEND_TO_NAME}
              RESEND_TO_EMAIL=${RESEND_TO_EMAIL}
              NEXTAUTH_URL=https://www.replie.me
              NEXTAUTH_SECRET=${AUTH_SECRET}
              EOF
            # Build the Next.js application
            - pnpm run build
      artifacts:
        # Main output
        baseDirectory: .
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    appRoot: .